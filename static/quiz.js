let currentEmail = null;
let questionCount = 0;
let maxQuestions = 10;

const sessionId = localStorage.getItem("session_id");
if(sessionId === null) {
  alert("Session expired. Please log in again.");
  window.location.href = "/";
}


// load email generated by AI
async function loadEmail() {

  const res = await fetch("/generate_email", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      company_name: "ExampleCorp",
      user_email: "user@example.com",
      position: "IT Specialist"
    })
  });

  currentEmail = await res.json();
  document.getElementById("emailBox").textContent = currentEmail.content;
}

// User submission 
async function submitAnswer(isPhishingGuess) {
  if (!currentEmail) return;

  const res = await fetch("/submit_answer", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email_id: currentEmail.id,
      is_phishing_guess: isPhishingGuess,
      highlights: []
    })
  });


  // get and compare the result; display feedback later
  const result = await res.json();
  document.getElementById("quizFeedback").textContent = `${result.feedback} (+${result.points_earned} pts)`;

  questionCount += 1;
  if (questionCount >= maxQuestions) {
    setTimeout(() => window.location.href = "/dashboard", 2000);
  } else {
    setTimeout(() => {
      document.getElementById("quizFeedback").textContent = "";
      loadEmail();
    }, 1000);
  }
}

window.onload = loadEmail;
